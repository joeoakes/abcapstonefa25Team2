name: System Environment Test

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  system-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install core dependencies
        run: |
          python -m pip install --upgrade pip
          pip install qiskit qiskit-aer qiskit-ibm-runtime
          pip install matplotlib pandas pylatexenc

      - name: Install repo dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found"
          fi

      - name: Run Shor noiseless demo
        run: |
          echo "Running 01-shor_noiseless_demo.py"
          python "01-shor_noiseless_demo.py"

      - name: Run Shor noisy demo
        run: |
          if [ -f "02-shor_noise_demo.py" ]; then
            echo "Running 02-shor_noise_demo.py"
            python "02-shor_noise_demo.py"
          fi

      - name: Run resource usage analysis
        run: |
          if [ -f "03-resource_visualization.py" ]; then
            echo "Running 03-resource_visualization.py"
            python "03-resource_visualization.py"
          fi

      - name: Verify expected output files exist
        run: |
          REQUIRED_FILES=(
            results.csv
            noiseless_plot.png
            noisy_plot.png
            benchmark_timing.png
            02benchmark_timing.png
            depth_gatecount.png
          )

          echo "Checking required files..."
          for f in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$f" ]; then
              echo "::error::Missing required file: $f"
              exit 1
            else
              echo "Found: $f"
            fi
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shor-simulation-output
          path: |
            *.png
            results.csv
